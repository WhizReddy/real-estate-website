'use client';

import { useEffect, useRef, useState } from 'react';
import { Property } from '@/types';
import { formatPrice } from '@/lib/utils';
import { 
  MapPin, 
  Navigation, 
  School, 
  ShoppingCart, 
  Hospital, 
  Coffee,
  Car,
  Train,
  Maximize2,
  Minimize2,
  ExternalLink,
  Layers
} from 'lucide-react';
import { MapError, NetworkError } from '@/components/ErrorComponents';
import { MapLoadingSkeleton } from '@/components/LoadingStates';
import { useErrorHandler, useNetworkError } from '@/hooks/useErrorHandler';

interface PropertyDetailMapProps {
  property: Property;
  nearbyProperties?: Property[];
  height?: string;
  showNeighborhood?: boolean;
  showDirections?: boolean;
  className?: string;
}

interface NeighborhoodPlace {
  id: string;
  name: string;
  type: 'school' | 'shopping' | 'hospital' | 'restaurant' | 'transport';
  distance: number;
  coordinates: { lat: number; lng: number };
  rating?: number;
  address?: string;
}

export default function PropertyDetailMap({
  property,
  nearbyProperties = [],
  height = '400px',
  showNeighborhood = true,
  showDirections = true,
  className = ''
}: PropertyDetailMapProps) {
  const mapRef = useRef<HTMLDivElement>(null);
  const mapInstanceRef = useRef<any>(null);
  const markersRef = useRef<any[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [mapLayer, setMapLayer] = useState<'street' | 'satellite'>('street');
  const [showNearbyPlaces, setShowNearbyPlaces] = useState(true);
  const [selectedPlace, setSelectedPlace] = useState<NeighborhoodPlace | null>(null);
  const [nearbyPlaces, setNearbyPlaces] = useState<NeighborhoodPlace[]>([]);
  
  const errorHandler = useErrorHandler({
    maxRetries: 3,
    onError: (error, errorId) => {
      console.error('Property map error:', error, errorId);
    }
  });
  const networkError = useNetworkError();

  // Mock nearby places data (in real app, this would come from an API)
  const mockNearbyPlaces: NeighborhoodPlace[] = [
    {
      id: '1',
      name: 'Shkolla e Mesme \"Fan Noli\"',
      type: 'school',
      distance: 0.3,
      coordinates: { lat: property.address.coordinates.lat + 0.002, lng: property.address.coordinates.lng + 0.001 },
      rating: 4.2,
      address: 'Rruga D√´shmor√´t e Kombit'
    },
    {
      id: '2',
      name: 'Qendra Tregtare \"Tirana East Gate\"',
      type: 'shopping',
      distance: 0.8,
      coordinates: { lat: property.address.coordinates.lat - 0.005, lng: property.address.coordinates.lng + 0.003 },
      rating: 4.5,
      address: 'Autostrada Tiran√´-Durr√´s'
    },
    {
      id: '3',
      name: 'Spitali Amerikan',
      type: 'hospital',
      distance: 1.2,
      coordinates: { lat: property.address.coordinates.lat + 0.008, lng: property.address.coordinates.lng - 0.002 },
      rating: 4.7,
      address: 'Rruga Dibres'
    },
    {
      id: '4',
      name: 'Mulliri Vjeter',
      type: 'restaurant',
      distance: 0.5,
      coordinates: { lat: property.address.coordinates.lat - 0.003, lng: property.address.coordinates.lng - 0.001 },
      rating: 4.3,
      address: 'Rruga Pjet√´r Bogdani'
    },
    {
      id: '5',
      name: 'Stacioni i Autobus√´ve',
      type: 'transport',
      distance: 0.7,
      coordinates: { lat: property.address.coordinates.lat + 0.004, lng: property.address.coordinates.lng + 0.002 },
      rating: 3.8,
      address: 'Sheshi Sk√´nderbej'
    }
  ];

  useEffect(() => {
    setNearbyPlaces(mockNearbyPlaces);
  }, [property]);

  const initializeMap = async () => {
    if (typeof window === 'undefined' || !mapRef.current) return;

    try {
      setIsLoading(true);
      errorHandler.reset();

      const L = await Promise.race([
        import('leaflet'),
        new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Leaflet loading timeout')), 10000)
        )
      ]) as any;

      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }

      markersRef.current = [];

      const map = L.map(mapRef.current, {
        center: [property.address.coordinates.lat, property.address.coordinates.lng],
        zoom: 15,
        minZoom: 10,
        maxZoom: 18,
        zoomControl: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        dragging: true,
        touchZoom: true,
        preferCanvas: true,
        renderer: L.canvas(),
      });

      // Add tile layer
      const tileUrl = mapLayer === 'satellite' 
        ? 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
        : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';

      L.tileLayer(tileUrl, {
        attribution: mapLayer === 'satellite' ? 'Esri' : 'OpenStreetMap',
        maxZoom: 18,
        timeout: 10000,
      }).addTo(map);

      mapInstanceRef.current = map;

      // Add main property marker
      addPropertyMarker(L, map, property);

      // Add nearby properties
      if (nearbyProperties.length > 0) {
        addNearbyPropertyMarkers(L, map, nearbyProperties);
      }

      // Add neighborhood places
      if (showNeighborhood && showNearbyPlaces) {
        addNeighborhoodMarkers(L, map, nearbyPlaces);
      }

      setIsLoading(false);
    } catch (error) {
      const err = error instanceof Error ? error : new Error(String(error));
      console.error('Property map initialization error:', err);
      
      if (networkError.checkNetworkError(err)) {
        // Handle network error
      }
      
      errorHandler.handleError(err);
      setIsLoading(false);
    }
  };

  const addPropertyMarker = (L: any, map: any, prop: Property) => {
    const coords = prop.address.coordinates;
    
    // Create custom marker for main property
    const mainMarkerIcon = L.divIcon({
      html: `
        <div class=\"main-property-marker bg-gradient-to-r from-red-600 to-red-700 text-white px-4 py-3 rounded-lg text-sm font-bold shadow-xl border-3 border-white relative\">
          <div class=\"absolute -top-2 -right-2 w-4 h-4 bg-red-500 rounded-full animate-pulse\"></div>
          ${formatPrice(prop.price)}
        </div>
      `,
      className: 'main-property-marker-container',
      iconSize: [120, 40],
      iconAnchor: [60, 40],
    });

    const marker = L.marker([coords.lat, coords.lng], { icon: mainMarkerIcon })
      .addTo(map);

    const popupContent = `
      <div class=\"p-4 min-w-[280px]\">
        <div class=\"flex items-start gap-3 mb-3\">
          <div class=\"w-2 h-2 bg-red-500 rounded-full mt-2 flex-shrink-0\"></div>
          <div>
            <h3 class=\"font-bold text-gray-900 mb-1\">${prop.title}</h3>
            <p class=\"text-sm text-gray-600 mb-2\">${prop.address.street}, ${prop.address.city}</p>
          </div>
        </div>
        
        <div class=\"grid grid-cols-3 gap-2 mb-3 text-xs\">
          <div class=\"text-center p-2 bg-gray-50 rounded\">
            <div class=\"font-semibold text-gray-900\">${prop.details.bedrooms}</div>
            <div class=\"text-gray-600\">Dhoma</div>
          </div>
          <div class=\"text-center p-2 bg-gray-50 rounded\">
            <div class=\"font-semibold text-gray-900\">${prop.details.bathrooms}</div>
            <div class=\"text-gray-600\">Banjo</div>
          </div>
          <div class=\"text-center p-2 bg-gray-50 rounded\">
            <div class=\"font-semibold text-gray-900\">${prop.details.squareFootage}</div>
            <div class=\"text-gray-600\">m¬≤</div>
          </div>
        </div>
        
        <div class=\"flex justify-between items-center mb-3\">
          <span class=\"text-lg font-bold text-red-600\">${formatPrice(prop.price)}</span>
          <span class=\"text-xs bg-red-100 text-red-800 px-2 py-1 rounded capitalize\">${prop.details.propertyType}</span>
        </div>
        
        <div class=\"flex gap-2\">
          <a href=\"https://www.google.com/maps/dir/?api=1&destination=${coords.lat},${coords.lng}\" 
             target=\"_blank\" 
             class=\"flex-1 bg-blue-600 text-white px-3 py-2 rounded text-xs hover:bg-blue-700 transition-all text-center font-medium\">
            üß≠ Navigim
          </a>
          <button onclick=\"window.open('/map?property=${prop.id}', '_blank')\" 
                  class=\"flex-1 bg-green-600 text-white px-3 py-2 rounded text-xs hover:bg-green-700 transition-all font-medium\">
            üó∫Ô∏è Harta e Plot√´
          </button>
        </div>
      </div>
    `;

    marker.bindPopup(popupContent, {
      maxWidth: 300,
      className: 'main-property-popup',
      closeButton: true,
    });

    markersRef.current.push(marker);
  };

  const addNearbyPropertyMarkers = (L: any, map: any, properties: Property[]) => {
    properties.forEach((prop) => {
      const coords = prop.address.coordinates;
      
      const nearbyMarkerIcon = L.divIcon({
        html: `
          <div class=\"nearby-property-marker bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-2 rounded-lg text-xs font-semibold shadow-lg border-2 border-white hover:from-blue-600 hover:to-blue-700 transition-all cursor-pointer\">
            ${formatPrice(prop.price)}
          </div>
        `,
        className: 'nearby-property-marker-container',
        iconSize: [100, 32],
        iconAnchor: [50, 32],
      });

      const marker = L.marker([coords.lat, coords.lng], { icon: nearbyMarkerIcon })
        .addTo(map);

      const popupContent = `
        <div class=\"p-3 min-w-[200px]\">
          <h4 class=\"font-semibold text-gray-900 mb-1 text-sm\">${prop.title}</h4>
          <p class=\"text-xs text-gray-600 mb-2\">${prop.address.street}</p>
          <div class=\"flex justify-between items-center mb-2\">
            <span class=\"font-bold text-blue-600 text-sm\">${formatPrice(prop.price)}</span>
            <span class=\"text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded\">${prop.details.propertyType}</span>
          </div>
          <a href=\"/properties/${prop.id}\" class=\"block w-full bg-blue-600 text-white px-3 py-2 rounded text-xs hover:bg-blue-700 transition-all text-center font-medium\">
            Shiko Detajet
          </a>
        </div>
      `;

      marker.bindPopup(popupContent, {
        maxWidth: 220,
        className: 'nearby-property-popup',
      });

      markersRef.current.push(marker);
    });
  };

  const addNeighborhoodMarkers = (L: any, map: any, places: NeighborhoodPlace[]) => {
    places.forEach((place) => {
      const icon = getPlaceIcon(place.type);
      const color = getPlaceColor(place.type);
      
      const placeMarkerIcon = L.divIcon({
        html: `
          <div class=\"neighborhood-marker bg-white border-2 border-${color}-500 rounded-full p-2 shadow-lg hover:shadow-xl transition-all cursor-pointer\">
            <div class=\"text-${color}-600 text-sm\">${icon}</div>
          </div>
        `,
        className: 'neighborhood-marker-container',
        iconSize: [32, 32],
        iconAnchor: [16, 16],
      });

      const marker = L.marker([place.coordinates.lat, place.coordinates.lng], { 
        icon: placeMarkerIcon 
      }).addTo(map);

      const popupContent = `
        <div class=\"p-3 min-w-[180px]\">
          <div class=\"flex items-center gap-2 mb-2\">
            <div class=\"text-${color}-600\">${icon}</div>
            <h4 class=\"font-semibold text-gray-900 text-sm\">${place.name}</h4>
          </div>
          <p class=\"text-xs text-gray-600 mb-2\">${place.address}</p>
          <div class=\"flex justify-between items-center mb-2\">
            <span class=\"text-xs text-gray-500\">${place.distance} km larg</span>
            ${place.rating ? `<div class=\"flex items-center gap-1\">
              <span class=\"text-yellow-500 text-xs\">‚≠ê</span>
              <span class=\"text-xs text-gray-600\">${place.rating}</span>
            </div>` : ''}
          </div>
          <a href=\"https://www.google.com/maps/dir/?api=1&destination=${place.coordinates.lat},${place.coordinates.lng}\" 
             target=\"_blank\" 
             class=\"block w-full bg-${color}-600 text-white px-3 py-1 rounded text-xs hover:bg-${color}-700 transition-all text-center font-medium\">
            Navigim
          </a>
        </div>
      `;

      marker.bindPopup(popupContent, {
        maxWidth: 200,
        className: 'neighborhood-popup',
      });

      marker.on('click', () => {
        setSelectedPlace(place);
      });

      markersRef.current.push(marker);
    });
  };

  const getPlaceIcon = (type: NeighborhoodPlace['type']) => {
    switch (type) {
      case 'school': return 'üè´';
      case 'shopping': return 'üõí';
      case 'hospital': return 'üè•';
      case 'restaurant': return 'üçΩÔ∏è';
      case 'transport': return 'üöå';
      default: return 'üìç';
    }
  };

  const getPlaceColor = (type: NeighborhoodPlace['type']) => {
    switch (type) {
      case 'school': return 'green';
      case 'shopping': return 'purple';
      case 'hospital': return 'red';
      case 'restaurant': return 'orange';
      case 'transport': return 'blue';
      default: return 'gray';
    }
  };

  useEffect(() => {
    initializeMap();

    return () => {
      if (mapInstanceRef.current) {
        try {
          mapInstanceRef.current.remove();
        } catch (error) {
          console.warn('Error cleaning up property map:', error);
        }
        mapInstanceRef.current = null;
        markersRef.current = [];
      }
    };
  }, [errorHandler.retryCount, mapLayer, showNearbyPlaces]);

  const handleRetry = () => {
    if (errorHandler.canRetry) {
      errorHandler.retry();
    }
  };

  const toggleFullscreen = () => {
    setIsFullscreen(!isFullscreen);
    setTimeout(() => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.invalidateSize();
      }
    }, 100);
  };

  const toggleMapLayer = () => {
    setMapLayer(prev => prev === 'street' ? 'satellite' : 'street');
  };

  return (
    <div className={`relative ${isFullscreen ? 'fixed inset-0 z-50 bg-white' : ''} ${className}`}>
      <div
        ref={mapRef}
        style={{ height: isFullscreen ? '100vh' : height }}
        className={`w-full ${isFullscreen ? '' : 'rounded-lg shadow-md border border-gray-200'} touch-pan-x touch-pan-y bg-gray-50`}
      />

      {/* Map Controls */}
      <div className="absolute top-3 right-3 flex flex-col gap-2 z-[1000]">
        {/* Fullscreen Toggle */}
        <button
          onClick={toggleFullscreen}
          className=\"bg-white hover:bg-gray-50 p-2 rounded-lg shadow-md border border-gray-200 transition-colors\"
          title={isFullscreen ? \"Exit Fullscreen\" : \"Fullscreen\"}
        >
          {isFullscreen ? (
            <Minimize2 className=\"h-4 w-4 text-gray-600\" />
          ) : (
            <Maximize2 className=\"h-4 w-4 text-gray-600\" />
          )}
        </button>

        {/* Layer Toggle */}
        <button
          onClick={toggleMapLayer}
          className=\"bg-white hover:bg-gray-50 p-2 rounded-lg shadow-md border border-gray-200 transition-colors\"
          title={mapLayer === 'street' ? 'Satellite View' : 'Street View'}
        >
          <Layers className=\"h-4 w-4 text-gray-600\" />
        </button>

        {/* Neighborhood Toggle */}
        {showNeighborhood && (
          <button
            onClick={() => setShowNearbyPlaces(!showNearbyPlaces)}
            className={`p-2 rounded-lg shadow-md border border-gray-200 transition-colors ${
              showNearbyPlaces 
                ? 'bg-blue-600 text-white hover:bg-blue-700' 
                : 'bg-white text-gray-600 hover:bg-gray-50'
            }`}
            title=\"Toggle Neighborhood Places\"
          >
            <MapPin className=\"h-4 w-4\" />
          </button>
        )}
      </div>

      {/* Directions Button */}
      {showDirections && (
        <div className=\"absolute bottom-3 right-3 z-[1000]\">
          <a
            href={`https://www.google.com/maps/dir/?api=1&destination=${property.address.coordinates.lat},${property.address.coordinates.lng}`}
            target=\"_blank\"
            rel=\"noopener noreferrer\"
            className=\"inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-blue-700 transition-colors font-medium\"
          >
            <Navigation className=\"h-4 w-4\" />
            Get Directions
          </a>
        </div>
      )}

      {/* Loading State */}
      {isLoading && (
        <div className=\"absolute inset-0 bg-white bg-opacity-95 flex items-center justify-center rounded-lg\">
          <MapLoadingSkeleton />
        </div>
      )}

      {/* Network Error State */}
      {networkError.networkError && (
        <div className=\"absolute inset-0 bg-white bg-opacity-95 flex items-center justify-center rounded-lg\">
          <NetworkError 
            onRetry={handleRetry}
            message={networkError.networkError}
          />
        </div>
      )}

      {/* General Error State */}
      {errorHandler.hasError && !networkError.networkError && (
        <div className=\"absolute inset-0 bg-white bg-opacity-95 flex items-center justify-center rounded-lg\">
          <MapError 
            onRetry={handleRetry}
            error={errorHandler.error?.message}
          />
        </div>
      )}

      {/* Neighborhood Legend */}
      {showNeighborhood && showNearbyPlaces && !isLoading && !errorHandler.hasError && (
        <div className=\"absolute bottom-3 left-3 bg-white rounded-lg shadow-md border border-gray-200 p-3 max-w-xs z-[1000]\">
          <h4 className=\"font-semibold text-gray-900 mb-2 text-sm\">Nearby Places</h4>
          <div className=\"space-y-1 text-xs\">
            <div className=\"flex items-center gap-2\">
              <span>üè´</span>
              <span className=\"text-gray-600\">Schools</span>
            </div>
            <div className=\"flex items-center gap-2\">
              <span>üõí</span>
              <span className=\"text-gray-600\">Shopping</span>
            </div>
            <div className=\"flex items-center gap-2\">
              <span>üè•</span>
              <span className=\"text-gray-600\">Healthcare</span>
            </div>
            <div className=\"flex items-center gap-2\">
              <span>üçΩÔ∏è</span>
              <span className=\"text-gray-600\">Restaurants</span>
            </div>
            <div className=\"flex items-center gap-2\">
              <span>üöå</span>
              <span className=\"text-gray-600\">Transport</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}